<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/static/imgs/sdjjico.jpg">
    <title>闪电降价发布系统</title>
    <!-- Bootstrap core CSS -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .blue
        {
        padding-left:20px;
        padding-top:20px
        }
        .allow
        {
        cursor:not-allowed
        }
    </style>

    <!-- Custom styles for this template -->
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <!--框架样式-->
    <link href="/static/css/home.css" rel="stylesheet">
    <!--小屏下，右移样式-->
    <link href="/static/css/offcanvas.css" rel="stylesheet">
    <!--代码更新（非框架）样式-->
    <link href="/static/css/release.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <link href="/static/css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
    <!--[if lt IE 9]>
    <script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]
    	<script src="../../assets/js/ie-emulation-modes-warning.js"></script>-->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="container-fluid">
    <div class="row row-offcanvas row-offcanvas-left">
        <div class="col-xs-6 col-sm-1  col-md-2 sidebar-offcanvas homedivtm" id="sidebar" role="navigation">
            <!--左导航-->
            {% include 'left_nav.html' %}

        </div>
        <!--col-sm-3 col-md-2 sidebar -->
        <div class="col-xs-12 col-sm-12  col-md-12 home-brand">
            <!--head-->
            {% include 'header_nav.html' %}
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-1 main">
            <div class="col-xs-12 col-sm-12 container" role="navigation">
                <p class="pull-left visible-xs">
                    <button type="button" class="btn btn-info btn-md" data-toggle="offcanvas">菜单</button>
                </p>
            </div>
            <!--框架主页开始-->
            <div style="border:1px solid #999;height:auto;margin-left:0px;margin-right:0px;margin-top:0px;" id="keleyidiv">
            <h4 align="center"></h4>
            <font size="4" class="blue" target="_blank" >条件搜索:</font> <span class="blue" target="_blank"  >项目分组</span>
                <select id="xiangmufenzu" name="xiangmufenzu" style="width:100px;height:23px;">
                    <option value="1">全部</option>
                    <option value="2">已分类</option>
                    <option value="3">未分类</option>
                </select>
                <span class="blue" target="_blank"  >机器状态</span>
                <select id="jiqizhuangtai" name="jiqizhuangtai" style="width:100px;height:23px;">
                    <option value="1">全部</option>
                    <option value="2">在线</option>
                    <option value="3">严重</option>
                    <option value="4">失联</option>
                </select>
                <button id='zhuangtaisearch' type="button" class="btn btn-success btn-default btn-sm">
                <span  class="glyphicon glyphicon-search" ></span>搜索
                </button>
            </br> </br>
            </div>
            <br/>
            <table class="table table-striped table-bordered table-hover dataTables-example">
                <thead>
                <tr>
                    <th class="text-center">排序id</th>
                    <th class="text-center">机器id</th>
                    <th class="text-center">机器IP地址</th>
                    <th class="text-center">机器内存 (G)</th>
                    <th class="text-center">机器cpu (核数)</th>
                    <th class="text-center">系统类型</th>
                    <th class="text-center">机器服务商</th>
                    <th class="text-center">服务分类</th>
                    <th class="text-center ">项目分组</th>
                    <th class="text-center">机器环境</th>
                    <th class="text-center">机器状态</th>
                    <th class="text-center">操作</th>
                </tr>
                </thead>
                <tbody>
                {% for info in res_info %}
                <tr class="gradeC">
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ forloop.counter }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.uid }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_ip }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_mem }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_cpu }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_system }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_position }}</td>
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.server_service }}</td>
                    <td class="text-center ">
                            {% load splitt %}
                        {% for info2 in info.group|splitt %}
                        <span class="label label-info" style="font-size:13px;text-align:center;line-height:30px;">{{ info2 }},</span>
                                <br/>
                            {% endfor %}
                    </td>
                    <!--<td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.group }}</td>-->
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">{{ info.env }}</td>
                    <td class="text-center" ><span class="label label-success" style="font-size:13px;text-align:center;line-height:50px;">{{ info.status }}</span></td>
                    <!--warning danger-->
                    <td class="text-center" style="font-size:15px;text-align:center;line-height:50px;">
                        <button onmouseup="update()" type="button"
                                class="btn btn-sm btn-outline btn-primary" data-toggle="modal"
                                >编辑
                        </button>
                        <button onmouseup="deleted()" type="button"
                                class="btn btn-sm btn-outline btn-danger">删除
                        </button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <button id="sx" onclick="shuaxin()" class="btn btn-outline btn-default">刷新
            </button>
            <button id="tj" type="button" class="btn btn-outline btn-default" data-toggle="modal"
                    data-target="#myModal5">添加
            </button>
            <button id="tjgroup" type="button" class="btn btn-outline btn-default" data-toggle="modal"
                    data-target="#myModal6">添加项目分组
            </button>
        </div>
    </div>
</div>
</div>
</div>
</div>
<div class="modal inmodal fade" id="myModal5" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"></span><span class="sr-only">Close</span></button>
                <h4 id="h4" class="modal-title">添加CMDB信息</h4>
                <!--<small class="font-bold"></small>-->
            </div>
            <div class="modal-body">
                <div>
                    <form class="form-horizontal m-t" id="signupForm" method="post" action="/cmdb/">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">机器IP地址：</label>

                            <div class="col-sm-8">
                                <input id="serverip" name="serverip" class="form-control" autocomplete="off" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">机器内存：</label>

                            <div class="col-sm-8">
                                <input id="memory" name="memory" class="form-control" type="text"
                                       aria-required="true" aria-invalid="false" class="valid">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">机器CPU：</label>

                            <div class="col-sm-8">
                                <input id="cpu" name="cpu" class="form-control" type="text"
                                       aria-required="true" aria-invalid="true" class="error">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">系统类型：</label>

                            <div class="col-sm-8">
                                <input id="release" name="release" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">机器服务商：</label>

                            <div class="col-sm-8">
                                <input id="complay" name="complay" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">服务分类：</label>

                            <div class="col-sm-8">
                                <input id="apisoft" name="apisoft" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">(此字段必须选择) 项目分组：</label>
                            <div class="col-sm-8">
                                <select id = "group" style="position: absolute;z-index: 10;width:570px" onmousedown="if(this.options.length>7){this.size=8}" onblur="this.size=0" onchange="this.size=0" class="form-control" name = "group" multiple="multiple">
                                    {% for selectinfo in select_info %}
                                    <option value = {{ selectinfo.id }}>{{ selectinfo.progroup }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!--<div class="col-sm-8">
                                <input id="group" name="group" class="form-control" type="text">
                            </div>-->
                        </div>
                         <div class="form-group">
                            <label class="col-sm-3 control-label">机器环境：</label>
                            <div class="col-sm-8">
                                <select id = "env" style="position: absolute;z-index: 1;width:570px" onmousedown="if(this.options.length>3){this.size=4}" onblur="this.size=0" onchange="this.size=0" class="form-control" name = "env">
                                    <option value ="1000">生产</option>
                                    <option value ="1001">灰度</option>
                                    <option value="1002">预发布</option>
                                    <option value="1003">测试</option>
                                </select>
                            </div>

                            <!--<div class="col-sm-8">
                                <input id="group" name="group" class="form-control" type="text">
                            </div>-->
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">(此字段不需要填写) 机器id：</label>

                            <div class="col-sm-8">
                                <input id="id" name="id" class="form-control" type="text" value="********"
                                       readonly="true">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="gb" type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
                            <input id="bc" type="submit" class="btn btn-primary" value="保存"/>
                            <input id='reset' type="reset" class="btn btn-info" value="重置"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal fade" id="myModal6" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"></span><span class="sr-only">Close</span></button>
                <h4 id="h41" class="modal-title">添加项目分组</h4>
                <!--<small class="font-bold"></small>-->
            </div>
            <div class="modal-body">
                <div>
                    <form class="form-horizontal m-t" id="signupForm1" method="post" action="/cmdb/group">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">项目分组：</label>

                            <div class="col-sm-8">
                                <input id="progroup" name="progroup" class="form-control" autocomplete="off" type="text">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="gbgroup" type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
                            <input id="bcgroup" type="submit" class="btn btn-primary" value="保存"/>
                            <input id='resetgroup' type="reset" class="btn btn-info" value="重置"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!--框架主页结束-->
</div>
<!--col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main -->
</div>
<!--row row-offcanvas row-offcanvas-left-->
</div>
<!--container-fluid -->

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/static/js/1.11.1/jquery.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/static/js/ie10-viewport-bug-workaround.js"></script>
<!--小屏下，右移效果-->
<script src="/static/js/offcanvas.js"></script>
<script src="/static/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="/static/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="/static/js/layer.js"></script>
<script src="/static/js/1.11.1/jquery.min.js"></script>

<link rel="stylesheet" href="http://cdn.bootcss.com/select2/4.0.3/css/select2.min.css" type="text/css" />
<script type="text/javascript" src="http://cdn.bootcss.com/select2/4.0.3/js/select2.min.js"></script>
<script type="text/javascript">
   // $.ajaxSetup({
   //     data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
   //});

$.noConflict();
        // jQuery.noConflict();  这个为database的引用
        $(document).ready(function () {
            $('.dataTables-example').dataTable();

            /* Init DataTables */
            var oTable = $('#editable').dataTable();

            /* Apply the jEditable handlers to the table */
            oTable.$('td').editable('../example_ajax.php', {
                "callback": function (sValue, y) {
                    var aPos = oTable.fnGetPosition(this);
                    oTable.fnUpdate(sValue, aPos[0], aPos[1]);
                },
                "submitdata": function (value, settings) {
                    return {
                        "row_id": this.parentNode.getAttribute('id'),
                        "column": oTable.fnGetPosition(this)[2]
                    };
                },

                "width": "90%",
                "height": "100%"
            });
        });



        function fnClickAddRow() {
            $('#editable').dataTable().fnAddData([
                "Custom row",
                "New row",
                "New row",
                "New row",
                "New row"]);
        }
 //----------------------------------------------------------------------------------------------------------------------------------------------

jQuery("#group").select2();
//删除弹出层选中的
function del(){
layer.confirm("确认要删除机器？",{icon:2,title:"当前机器ID为 " + "【 " + iidd+ " 】" +" 请确保正确!!!"},function(index){
                jQuery.ajax({
                    url: '/del_cmdb/',
                    async: false,
                    type: 'post',
                    data: {num: iidd},
                    success: function (arg) {
                        if (arg) {
                            window.location.href = '/cmdb'
                        }
            }
            });
        })
}

 //* 开始帅选出按钮所在的位置
        function deleted() {
         jQuery.noConflict();
         jQuery("table tbody tr").find('td:last').find('button:last').click(function () {
                iidd = jQuery(this).parents('td').siblings('td').eq(1).text();
                console.log(iidd);
                del()
                });
        }


// 更新编辑操作
        function update() {
        jQuery('#tj').click();//此时顺带去模拟点击添加按钮
           // jQuery.noConflict();
            //console.log('ok')
            jQuery("table tbody tr").find('td:last').find('button:first').click(function () {
                var id0 = jQuery(this).parents('td').siblings('td').eq(1).text();
                var id1 = jQuery(this).parents('td').siblings('td').eq(2).text();
                var id2 = jQuery(this).parents('td').siblings('td').eq(3).text();
                var id3 = jQuery(this).parents('td').siblings('td').eq(4).text();
                var id4 = jQuery(this).parents('td').siblings('td').eq(5).text();
                var id5 = jQuery(this).parents('td').siblings('td').eq(6).text();
                var id6 = jQuery(this).parents('td').siblings('td').eq(7).text();
                var id7 = jQuery(this).parents('td').siblings('td').eq(8).text();
                var id8 = jQuery(this).parents('td').siblings('td').eq(9).text();
                console.log(id1, id2, id3, id4, id5, id6, id7,id8, id0);
                jQuery("#serverip").attr("value", id1 + "                                                                                                                                                              |" + id0);
                jQuery("#memory").attr("value", id2);
                jQuery("#cpu").attr("value", id3);
                jQuery("#release").attr("value", id4);
                jQuery("#complay").attr("value", id5);
                jQuery("#apisoft").attr("value", id6);
                var aa = id7.replace(/\s+/g,"");
                id7 = aa.substring(0,aa.length-1)
                jQuery("#group option").each(function(){
                if (id7.split(",").length > 1) {
                                    $(".select2-selection__rendered").empty()
                                    for(var i=0;i<id7.split(",").length;i++){
                                       jQuery(".select2-selection__rendered").append('<li class="select2-selection__choice" title='+ id7.split(",")[i] +'><span class="select2-selection__choice__remove" role="presentation">×</span>'+id7.split(",")[i]+'</li>')
                                        jQuery("")
                                        console.log("ok")
                                       if (jQuery(this).text() == id7.split(",")[i]){
                                       console.log("ookk")
                                       $(this).attr('selected', true);
                                       //jQuery(".select2-selection__rendered").append('<li class="select2-selection__choice" title='+ id7.split(",")[1] +'><span class="select2-selection__choice__remove" role="presentation">×</span>'+id7.split(",")[1]+'</li>')

                }
                }
                }else {
                for(var i=0;i<id7.split(",").length;i++){
                              if (jQuery(this).text() == id7.split(",")[i]){
                              console.log("oookkk")
                                       $(".select2-selection__rendered").empty()
                                       jQuery(".select2-selection__rendered").append('<li class="select2-selection__choice" title='+ id7.split(",")[i] +'><span class="select2-selection__choice__remove" role="presentation">×</span>'+id7.split(",")[i]+'</li>')
                                       $(this).attr('selected', true);
                              }

                }
                                  //if ($(this).text() == id7.split(",")[0] || $(this).text() == id7.split(",")[1] ) {
                                     //$(this).attr('selected', true);
                                     //$(".select2-selection__rendered").empty();
                                     //$(".select2-selection__rendered").append('<li class="select2-selection__choice" title='+ id7.split(",")[0] +'><span class="select2-selection__choice__remove" role="presentation">×</span>'+id7.split(",")[0]+'</li>')
                                    // $(".select2-selection__rendered").append('<li class="select2-selection__choice" title='+ id7.split(",")[1] +'><span class="select2-selection__choice__remove" role="presentation">×</span>'+id7.split(",")[1]+'</li>')
                                  //}

                                  }
                         })
                 jQuery("#env option").each(function(){
                                  if ($(this).text() == id8) {
                                     $(this).attr('selected', true);
                                  }
                                  })
                //jQuery("#group").attr("selected", "selected");
                //jQuery("#group").prepend("<b>Prepended text</b>");
                jQuery("#id").attr("value", id0);
                jQuery("#h4").text("编辑CMDB信息")
                jQuery('#gb').click(function(){    //当点击为关闭的时候
                    jQuery('#reset').trigger('click');
                    jQuery("#serverip").attr("value", "");
                    jQuery("#memory").attr("value", "");
                    jQuery("#cpu").attr("value", "");
                    jQuery("#release").attr("value", "");
                    jQuery("#complay").attr("value", "");
                    jQuery("#apisoft").attr("value", "");
                    jQuery(".select2-selection__rendered").empty();
                    jQuery("#env option").attr("selected", false);
                    jQuery("#group option").attr("selected", false);
                    jQuery("#id").attr("value", "********");
                    jQuery("#h4").text("添加CMDB信息")
                    })
              //  $.noConflict()
            })
           // console.log("nidaye")
        }

//***********************************刷新按钮的逻辑
        function shuaxin(){
            window.location.href=window.location.href
        }

//***********************************机器状态显示按钮
     jQuery("table tbody tr").each(function(){
        if (jQuery(this).find('td').eq(10).text() == "在线"){
                jQuery(this).find('td').eq(10).find('span').attr("class","label label-success")} else if (jQuery(this).find('td').eq(10).text() == "严重"){
                        jQuery(this).find('td').eq(10).find('span').attr("class","label label-warning")} else {
                                jQuery(this).find('td').eq(10).find('span').attr("class","label label-danger")
                        }
        })




//************************************条件搜索搜索按钮点击事件
jQuery("#zhuangtaisearch").click(function () {
        var num1 = jQuery("#xiangmufenzu").find("option:selected").text();
        var num2 = jQuery("#jiqizhuangtai").find("option:selected").text();
        jQuery.ajax({
                    url: '/cmdb/Cmdb_select/',
                    async: false,
                    type: 'post',
                    data: {num1:num1,num2:num2},
                    success: function (arg) {
                        if (arg) {
                            //console.log(arg)
                            window.location.href = arg
                        }
            }
            });
})

</script>
</body>
</html>